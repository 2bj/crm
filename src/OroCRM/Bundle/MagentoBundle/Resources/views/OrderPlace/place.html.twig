{% extends bap.layout %}
{% import 'OroUIBundle::macros.html.twig' as macros %}
{#  @TODO:
        - add title
        - add back button and pass URL from controller
        - add breadcrumbs
#}
{% block content %}
    <iframe src="{{ sourceUrl|raw }}" width="1200" height="600" frameborder="0"></iframe>

    {% if requireTransition is defined and requireTransition is sameas(true) %}
        {% set transitionURL %}
            {{
                path('oro_workflow_api_rest_workflow_transit', {
                    transitionName: 'convert',
                    workflowItemId: entity.workflowItem.id
                })
            }}
        {% endset %}
        {% set syncURL = path('orocrm_magento_orderplace_sync', {id: entity.id}) %}
        <script type="text/javascript">
            var ORO_ORDER_EMBED_API = {};

            require(['jquery', 'jquery.ajax.queue', 'oroui/js/messenger', 'orotranslation/js/translator', 'oronavigation/js/navigation'],
            function ($, ajaxQueue, messenger, __, Navigation) {
                var transitionUrl = {{ transitionURL|trim|json_encode|raw }},
                    syncUrl = {{ syncURL|trim|json_encode|raw }},
                    navigation = Navigation.getInstance();

                ORO_ORDER_EMBED_API.success = function () {
                    navigation.loadingMask.show();

                    var transitAction = {url: transitionUrl, dataType: 'json'};
                    transitAction.beforeSend = function ()  {
                        messenger.notificationFlashMessage('warning', __('orocrm.magento.performing_transition'));
                    };
                    transitAction.success = function () {
                        messenger.notificationFlashMessage('success', __('orocrm.magento.transition_performed'));
                    };
                    transitAction.failure = function () {
                        messenger.notificationFlashMessage('error', __('orocrm.magento.transition_error'));
                    };

                    var syncAction = {url: syncUrl};
                    syncAction.beforeSend = function ()  {
                        messenger.notificationFlashMessage('warning', __('orocrm.magento.performing_synchronization'));
                    };
                    syncAction.success = function () {
                        messenger.notificationFlashMessage('success', __('orocrm.magento.synchronization_success'));
                    };
                    syncAction.failure = function () {
                        messenger.notificationFlashMessage('error', __('orocrm.magento.synchronization_error'));
                    };

                    $.ajaxQueue(transitAction);
                    $.ajaxQueue(syncAction).always(function () {
                        navigation.setLocation({{ backUrl|json_encode|raw }});
                    });
                };

                ORO_ORDER_EMBED_API.error = function () {
                    messenger.notificationFlashMessage('error', __('orocrm.magento.external_error'));
                };
            });
        </script>
    {% endif %}
{% endblock %}
