{% extends bap.layout %}
{% import 'OroUIBundle::macros.html.twig' as macros %}

{% block content %}
    <iframe src="{{ sourceUrl|raw }}" width="1200" height="600" frameborder="0"></iframe>

    {% if requireTransition is defined and requireTransition is sameas(true) %}
        {% set transitionURL %}
            {{
                path('oro_workflow_api_rest_workflow_transit', {
                    transitionName: 'convert',
                    workflowItemId: entity.workflowItem.id
                })
            }}
        {% endset %}
        <script type="text/javascript">
            var ORO_ORDER_EMBED_API = {};

            require(['jquery', 'oroui/js/messenger', 'orotranslation/js/translator', 'oronavigation/js/navigation'],
            function ($, messenger, __, Navigation) {
                var transitionUrl = {{ transitionURL|trim|json_encode|raw }},
                    navigation = Navigation.getInstance();

                // @TODO create iframe async here
                // @TODO handle iframe load error/success here

                ORO_ORDER_EMBED_API.success = function () {
                    navigation.loadingMask.show();
                    messenger.notificationFlashMessage('warning', __('orocrm.magento.performing_transition'));

                    $.getJSON(transitionUrl)
                        .done(function() {
                            messenger.notificationFlashMessage('success', __('orocrm.magento.transition_performed'));
                        }).fail(function() {
                            messenger.notificationFlashMessage('error', __('orocrm.magento.transition_error'));
                        }).always(function() {
                            navigation.loadingMask.hide();
                            // @TODO further sync here
                            navigation.setLocation({{ backUrl|json_encode|raw }});
                        });
                };

                ORO_ORDER_EMBED_API.error = function () {
                    messenger.notificationFlashMessage('error', __('orocrm.magento.external_error'));
                    // @TODO error handling here
                };
            });
        </script>
    {% endif %}
{% endblock %}
