{% extends 'OroUIBundle:actions:view.html.twig' %}
{% import 'OroUIBundle::macros.html.twig' as macros %}
{% import 'OroNavigationBundle:Include:contentTags.html.twig' as navigationMacro %}

{% block pageHeader %}
    {% set breadcrumbs = {
    'entity': entity,
    'indexPath': path('orocrm_magento_cart_view', {id: entity.id}),
    'indexLabel': 'orocrm.magento.cart.entity_label'|trans ~ ' ' ~ entity.originId,
    'entityTitle': 'Place order'
    } %}
    {{ parent() }}
{% endblock pageHeader %}

{% block navButtonContainer %}
    {% if backUrl is defined %}
        {{ UI.Button({
        'path':   backUrl,
        'aCss':   'btn back icons-holder-text',
        'title' : 'Back',
        'label' : 'Back'
        }) }}
    {% endif %}
{% endblock navButtonContainer%}

{% block pageActions %}{% endblock pageActions %}
{% block content_datagrid %}{% endblock content_datagrid %}
{% block workflowStepListContainer %}{% endblock workflowStepListContainer %}
{% block navigation_content_tags %}{% endblock navigation_content_tags %}

{% block content_data %}

    <iframe id="orderPlaceFrame" src="{{ sourceUrl|raw }}" width="1" height="1"  frameborder="0"></iframe>
    {#<iframe id="orderPlaceFrame" src="http://sdbwergbw.csergwerg" width="1"  frameborder="0"></iframe>#}

    {% if requireTransition is defined and requireTransition is sameas(true) %}
        {% set transitionURL %}
        {{
        path('oro_workflow_api_rest_workflow_transit', {
        transitionName: 'convert',
        workflowItemId: entity.workflowItem.id
        })
        }}
        {% endset %}
        <script type="text/javascript">
            var ORO_ORDER_EMBED_API = {};
            require(['jquery', 'oroui/js/messenger', 'orotranslation/js/translator', 'oronavigation/js/navigation'],
                function ($, messenger, __, Navigation) {

                    var transitionUrl = {{ transitionURL|trim|json_encode|raw }},
                        navigation = Navigation.getInstance(),
                        contentContainer = $('#container'),
                        containerFluidClass = $('.container-fluid'),
                        loaded = false
                    ;

                    var ResizeIframe = function(contentContainer, containerFluid) {
                        var deviation = 5;
                        var heightResult = (contentContainer.height() - deviation) - containerFluid.height();
                        $('#orderPlaceFrame').css( 'height', (heightResult)+'px');
                        $('#orderPlaceFrame').css( 'width', '100%');
                    }

                    navigation.loadingMask.show();

                    $("#orderPlaceFrame").load(function () {
                        console.log('loaded');
                        ResizeIframe(contentContainer, containerFluidClass);
                        navigation.loadingMask.hide();
                        loaded = true;

                    })
                    .ready(function() {
                        var counter = 0;
                        var FF = setInterval( function() {
                            counter ++;
                            if (true === loaded) {
                                clearInterval(FF);
                            }
                            if (counter >= 5) {
                                clearInterval(FF);
                                if (false === loaded) {
                                    ORO_ORDER_EMBED_API.error();
                                }
                            }
                         },2000);
                    });

                    $(window).on("resize",function (){
                        ResizeIframe(contentContainer, containerFluidClass);
                    });

                    contentContainer.on("resize",function (){
                        ResizeIframe(contentContainer, containerFluidClass);
                    });

                    // @TODO create iframe async here
                    // @TODO handle iframe load error/success here
                    ORO_ORDER_EMBED_API.success = function () {
                        navigation.loadingMask.show();
                        messenger.notificationFlashMessage('warning', __('orocrm.magento.performing_transition'));
                        $.getJSON(transitionUrl)
                                .done(function() {
                                    navigation.loadingMask.hide();
                                    messenger.notificationFlashMessage('success', __('orocrm.magento.transition_performed'));
                                }).fail(function() {
                                    messenger.notificationFlashMessage('error', __('orocrm.magento.transition_error'));
                                }).always(function() {
                                    navigation.loadingMask.hide();
                                    // @TODO further sync here
                                    navigation.setLocation({{ backUrl|json_encode|raw }});
                                });
                        console.log('success');
                    };

                    ORO_ORDER_EMBED_API.error = function () {
                        $('#orderPlaceFrame').css('width', '1');
                        $('#orderPlaceFrame').css('height', '1');
                        console.log('error');
                        navigation.loadingMask.hide();
                        messenger.notificationFlashMessage('error', __('orocrm.magento.external_error'));
                        navigation.setLocation({{ backUrl|json_encode|raw }});
                    };

                });
        </script>
    {% endif %}
{% endblock %}

