{% extends 'OroUIBundle:actions:view.html.twig' %}
{% import 'OroUIBundle::macros.html.twig' as macros %}
{% import 'OroNavigationBundle:Include:contentTags.html.twig' as navigationMacro %}

{% block pageHeader %}
    {% set breadcrumbs = {
        'entity': entity,
        'indexPath': path('orocrm_magento_cart_view', {id: entity.id}),
        'indexLabel': 'orocrm.magento.cart.entity_label'|trans ~ ' ' ~ entity.originId,
        'entityTitle': 'Place order'
    } %}
    {{ parent() }}
{% endblock pageHeader %}

{% block navButtonContainer %}
    {% if backUrl is defined %}
        {{ UI.Button({
            'path':   backUrl,
            'aCss':   'btn back icons-holder-text',
            'title' : 'Back',
            'label' : 'Back'
        }) }}
    {% endif %}
{% endblock navButtonContainer%}

{% block pageActions %}{% endblock pageActions %}
{% block content_datagrid %}{% endblock content_datagrid %}
{% block workflowStepListContainer %}{% endblock workflowStepListContainer %}
{% block navigation_content_tags %}{% endblock navigation_content_tags %}

{% block content_data %}
    <iframe id="orderPlaceFrame" src="{{ sourceUrl|raw }}" width="1" height="1"  frameborder="0"></iframe>

    {% if requireTransition is defined and requireTransition is sameas(true) %}
        {% set transitionURL %}
        {{
            path('oro_workflow_api_rest_workflow_transit', {
                transitionName: 'convert',
                workflowItemId: entity.workflowItem.id
            })
        }}
        {% endset %}
        {% set syncURL = path('orocrm_magento_orderplace_sync', {id: entity.id}) %}
        <script type="text/javascript">
            var ORO_ORDER_EMBED_API = {};

            require(['jquery', 'oroui/js/messenger', 'orotranslation/js/translator', 'oronavigation/js/navigation', 'jquery.ajax.queue'],
            function ($, messenger, __, Navigation) {
                var transitionUrl = {{ transitionURL|trim|json_encode|raw }},
                    syncUrl = {{ syncURL|trim|json_encode|raw }},
                    navigation = Navigation.getInstance(),
                    $frame = $('#orderPlaceFrame'),
                    contentContainer = $('#container'),
                    containerFluid = $('.container-fluid'),
                    loaded = false,
                    resizeIframe = function() {
                        var deviation = 5,
                            heightResult = (contentContainer.height() - deviation) - containerFluid.height();
                        $frame.css( 'height', (heightResult)+'px');
                        $frame.css( 'width', '100%');
                    };

                navigation.loadingMask.show();

                $frame.load(function () {
                    resizeIframe();
                    if (!loaded) {
                        navigation.loadingMask.hide();
                    }
                    loaded = true;
                }).ready(function() {
                    var counter = 0;
                    var FF = setInterval( function() {
                        counter ++;
                        if (counter >= 5) {
                            clearInterval(FF);
                            if (false === loaded) {
                                ORO_ORDER_EMBED_API.error();
                            }
                        }
                    }, 2000);
                });

                $(window).on("resize",function (){
                    resizeIframe();
                });
                contentContainer.on("resize",function (){
                    resizeIframe();
                });

                ORO_ORDER_EMBED_API.success = function () {
                    navigation.loadingMask.show();

                    var transitAction = {url: transitionUrl, dataType: 'json'};
                    transitAction.beforeSend = function ()  {
                        messenger.notificationFlashMessage('warning', __('orocrm.magento.performing_transition'));
                    };
                    transitAction.success = function () {
                        messenger.notificationFlashMessage('success', __('orocrm.magento.transition_performed'));
                    };
                    transitAction.error = function () {
                        messenger.notificationFlashMessage('error', __('orocrm.magento.transition_error'));
                    };

                    var syncAction = {url: syncUrl};
                    syncAction.beforeSend = function ()  {
                        messenger.notificationFlashMessage('warning', __('orocrm.magento.performing_synchronization'));
                    };
                    syncAction.success = function () {
                        messenger.notificationFlashMessage('success', __('orocrm.magento.synchronization_success'));
                    };
                    syncAction.error = function () {
                        messenger.notificationFlashMessage('error', __('orocrm.magento.synchronization_error'));
                    };

                    $.ajaxQueue(transitAction);
                    $.ajaxQueue(syncAction).always(function () {
                        navigation.setLocation({{ backUrl|json_encode|raw }});
                    });
                };

                ORO_ORDER_EMBED_API.error = function () {
                    $frame.css('width', '1px').css('height', '1px');
                    messenger.notificationFlashMessage('error', __('orocrm.magento.external_error'));
                    navigation.setLocation({{ backUrl|json_encode|raw }});
                };
            });
        </script>
    {% endif %}
{% endblock %}
