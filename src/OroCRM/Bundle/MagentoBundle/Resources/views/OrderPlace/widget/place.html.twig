{% block page_container %}
    <div class="order-form-widget widget-content">
        {% if error is sameas(false) %}
            <iframe id="orderPlaceFrame" src="{{ sourceUrl|raw }}" width="1" height="1" frameborder="0"></iframe>

            <script type="text/javascript">
                var ORO_ORDER_EMBED_API = {};

                require(['jquery', 'oroui/js/widget-manager', 'oroui/js/messenger', 'orotranslation/js/translator'],
                function ($, widgetManager, messenger, __) {
                    var $frame = $('#orderPlaceFrame'),
                        modalWidgetAlias = 'transaction-dialog';

                    widgetManager.getWidgetInstanceByAlias(modalWidgetAlias, function (widget) {
                        widget.getWidget().dialog('maximize');
                    });

                    $frame.load(function () {
                        $frame.css({'height': '100%', 'width': '100%'});

                        widgetManager.getWidgetInstance({{ app.request.get('_wid')|json_encode|raw }}, function(widget) {
                            widget.trigger('externalContentLoaded')
                        });
                    });

                    ORO_ORDER_EMBED_API.success = function () {
                        messenger.notificationFlashMessage('warning', __('orocrm.magento.performing_synchronization'));
                        widgetManager.getWidgetInstanceByAlias(modalWidgetAlias, function (widget) {
                            widget.trigger('formSave');

                            {% if cartId is defined %}
                            $('#transition-b2c_flow_abandoned_shopping_cart-place_order').one('transitions_success', function() {
                                {% set syncURL = path('orocrm_magento_orderplace_sync', {id: cartId}) %}
                                $.ajax({
                                    dataType: 'json',
                                    url: {{ syncURL|json_encode|raw }},
                                    success: function(data) {
                                        messenger.notificationFlashMessage(data.statusType, data.message);
                                    }
                                });
                            });
                            {% elseif customerId is defined %}
                                {% set syncURL = path('orocrm_magento_orderplace_customer_sync', {id: customerId}) %}
                                $.ajax({
                                    dataType: 'json',
                                    url: {{ syncURL|json_encode|raw }},
                                    beforeSend: function() {
                                        widget.remove();
                                    },
                                    success: function(data ) {
                                        messenger.notificationFlashMessage(data.statusType, data.message);
                                    },
                                    error: function() {
                                        messenger.notificationFlashMessage('error', __('orocrm.magento.external_error'));

                                    }
                                });
                            {% endif %}

                        });
                    };

                    ORO_ORDER_EMBED_API.error = function () {
                        messenger.notificationFlashMessage('error', __('orocrm.magento.external_error'));

                        widgetManager.getWidgetInstanceByAlias(modalWidgetAlias, function (widget) {
                            widget.remove();
                        });
                    };
                });
            </script>
        {% else %}
            <script type="text/javascript">
                require(['oroui/js/widget-manager', 'oroui/js/messenger'],
                function (widgetManager, messenger) {
                    messenger.notificationFlashMessage('error', {{ error|json_encode|raw }});

                    widgetManager.getWidgetInstanceByAlias('transaction-dialog', function (widget) {
                        widget.remove();
                    });
                });
            </script>
        {% endif %}
    </div>
{% endblock %}
