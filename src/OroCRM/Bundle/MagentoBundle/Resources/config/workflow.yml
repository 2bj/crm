workflows:
    b2c_flow_abandoned_shopping_cart:
        label: 'Abandoned Shopping Cart'
        enabled: true
        entity: OroCRM\Bundle\MagentoBundle\Entity\Cart
        entity_attribute: cart
        start_step: open
        steps:
            open:
                label: 'Open'
                order: 10
                allowed_transitions:
                    - log_call
                    - send_email
                    - convert_to_opportunity
            contacted:
                label: 'Contacted'
                order: 20
                allowed_transitions:
                    - log_call
                    - send_email
                    - convert
                    - convert_to_opportunity
                    - abandon
            abandoned:
                label: 'Abandoned'
                order: 30
                allowed_transitions:
                    - reopen
            converted_to_opportunity:
                label: 'Converted to opportunity'
                order: 30
                allowed_transitions:
                    - reopen
            converted:
                label: 'Converted'
                order: 30
                allowed_transitions:
                    - reopen

        attributes:
            # Call related fields
            call:
                label: 'Call log'
                type: entity
                options:
                    class: OroCRM\Bundle\CallBundle\Entity\Call
            phone_number:
                label: 'Phone number'
                type: string
            call_subject:
                label: 'Call subject'
                type: string
            call_date:
                label: 'Call date'
                type: object
                options:
                    class: DateTime
            call_direction:
                label: 'Call direction'
                type: entity
                options:
                    class: OroCRM\Bundle\CallBundle\Entity\CallDirection
            call_status:
                label: 'Call status'
                type: entity
                options:
                    class: OroCRM\Bundle\CallBundle\Entity\CallStatus
            call_duration:
                label: 'Call duration'
                type: object
                options:
                    class: DateTime

            # Email related fields
            email:
                label: 'Email'
                type: entity
                options:
                    class: Oro\Bundle\EmailBundle\Entity\Email
            email_from:
                label: 'Email sender'
                type: string
            email_to:
                label: 'Email recipient'
                type: string
            email_subject:
                label: 'Email subject'
                type: string
            email_body:
                label: 'Email content'
                type: string

            # Other workflow attributes
            notes:
                label: 'Note'
                type: string
            opportunity_name:
                label: 'Opportunity name'
                type: string
            opportunity_owner:
                label: 'Owner'
                type: entity
                options:
                    class: Oro\Bundle\UserBundle\Entity\User
            opportunity_budget:
                label: 'Budget amount'
                type: float
            account:
                label: 'Account'
                type: entity
                options:
                    class: OroCRM\Bundle\AccountBundle\Entity\Account
            contact:
                label: 'Contact'
                type: entity
                options:
                    class: OroCRM\Bundle\ContactBundle\Entity\Contact

        transitions:
            log_call:
                label: 'Log call'
                step_to: contacted
                is_start: true
                is_unavailable_hidden: true
                frontend_options:
                    icon: 'icon-phone'
                transition_definition: log_call_definition
                form_options:
                    attribute_fields:
                        phone_number:
                            form_type: text
                            options:
                                required: true
                                constraints:
                                    - NotBlank: ~
                        call_subject:
                            form_type: text
                            options:
                                required: true
                                constraints:
                                    - NotBlank: ~
                        call_date:
                            form_type: oro_datetime
                            options:
                                required: true
                                constraints:
                                    - NotBlank: ~
                        account:
                            form_type: orocrm_account_select
                            options:
                                required: false
                                label: 'Related to'
                        contact:
                            form_type: orocrm_contact_select
                            options:
                                required: false
                                label: 'Related contact'
                        call_direction:
                            form_type: entity
                            options:
                                class: OroCRM\Bundle\CallBundle\Entity\CallDirection
                                property: label
                                required: true
                                constraints:
                                    - NotBlank: ~
                        call_duration:
                            form_type: time
                            options:
                                required: false
                                widget: single_text
                                with_seconds: true
                        notes:
                            form_type: textarea
                            options:
                                required: false
                    attribute_default_values:
                        call_subject: 'Shopping cart status refresh'
                    init_actions:
                        - @assign_value:
                            conditions:
                                @and:
                                    - @empty: $phone_number
                                    - @not_empty: $cart.customer
                                    - @not_empty: $cart.customer.contact
                                    - @not_empty: $cart.customer.contact.primaryPhone
                            parameters: [$phone_number, $cart.customer.contact.primaryPhone.phone]
                        - @assign_value:
                            conditions:
                                @and:
                                    - @empty: $account
                                    - @not_empty: $cart.customer
                                    - @not_empty: $cart.customer.account
                            parameters: [$account, $cart.customer.account]
                        - @assign_value:
                            conditions:
                                @and:
                                    - @empty: $contact
                                    - @not_empty: $cart.customer
                                    - @not_empty: $cart.customer.contact
                            parameters: [$contact, $cart.customer.contact]
                        - @create_object:
                            class: '\DateTime'
                            attribute: $call_date
                        - @create_object:
                            class: '\DateTime'
                            arguments:
                                - '00:00:00'
                            attribute: $call_duration
            send_email:
                label: 'Send email'
                step_to: contacted
                is_start: true
                is_unavailable_hidden: true
                frontend_options:
                    icon: 'icon-envelope-alt'
                    dialog:
                        dialogOptions:
                            width: 700
                transition_definition: send_email_definition
                form_options:
                    attribute_fields:
                        email_from:
                            form_type: oro_email_email_address
                            options:
                                required: true
                                constraints:
                                    - NotBlank: ~
                                    - Email: ~
                        email_to:
                            form_type: oro_email_email_address
                            options:
                                required: true
                                constraints:
                                    - NotBlank: ~
                                    - Email: ~
                        email_subject:
                            form_type: text
                            options:
                                required: true
                                constraints:
                                    - NotBlank: ~
                        email_body:
                            form_type: textarea
                            options:
                                required: true
                                attr:
                                    style: 'width: 90%;height: 200px;'
                                constraints:
                                    - NotBlank: ~
                        notes:
                            form_type: textarea
                            options:
                                required: false
                                attr:
                                    style: 'width: 90%;height: 60px'
                    init_actions:
                        - @assign_active_user: $.result.user
                        - @assign_value: [$email_from, $.result.user.email]
                        - @assign_value: #Assign email to as shopping cart email
                            conditions:
                                @and:
                                    - @empty: $email_to
                                    - @not_empty: $cart.email
                            parameters: [$email_to, $cart.email]
                        - @assign_value: #Assign email to as shopping cart customer email
                            conditions:
                                @and:
                                    - @empty: $email_to
                                    - @not_empty: $cart.customer
                                    - @not_empty: $cart.customer.email
                            parameters: [$email_to, $cart.customer.email]
                        - @assign_value: #Assign email to as shopping cart customer contact primary email
                            conditions:
                                @and:
                                    - @empty: $email_to
                                    - @not_empty: $cart.customer
                                    - @not_empty: $cart.customer.contact
                                    - @not_empty: $cart.customer.contact.primaryEmail
                            parameters: [$email_to, $cart.customer.contact.primaryEmail.email]

            convert:
                label: 'Convert'
                step_to: converted
                is_unavailable_hidden: true
                frontend_options:
                    icon: 'icon-shopping-cart'
                transition_definition: convert_definition
                form_options:
                    attribute_fields:
                        notes:
                            form_type: textarea
                            options:
                                required: false
            convert_to_opportunity:
                label: 'Convert to opportunity'
                step_to: converted_to_opportunity
                is_start: true
                is_unavailable_hidden: true
                frontend_options:
                    icon: 'icon-usd'
                transition_definition: convert_to_opportunity_definition
                form_options:
                    attribute_fields:
                        opportunity_name:
                            form_type: text
                            options:
                                required: true
                                constraints:
                                    - NotBlank: ~
                        opportunity_owner:
                            form_type: oro_user_select
                            options:
                                required: true
                                constraints:
                                    - NotBlank: ~
                        account:
                            form_type: orocrm_account_select
                            options:
                                required: true
                                constraints:
                                    - NotBlank: ~
                        opportunity_budget:
                            form_type: oro_money
                            options:
                                required: false
                        notes:
                            form_type: textarea
                            options:
                                required: false
                    attribute_default_values:
                        opportunity_budget: $cart.subTotal
                    init_actions:
                        - @assign_active_user: $opportunity_owner
                        - @format_name:
                            attribute: $.result.formattedCustomerName
                            object: $cart.customer
                        - @format_string:
                            attribute: $opportunity_name
                            string: '%customer_name% - %shopping_cart_id%'
                            arguments:
                                customer_name: $.result.formattedCustomerName
                                shopping_cart_id: $cart.id
                        - @assign_value:
                            conditions:
                                @and:
                                    - @empty: $account
                                    - @not_empty: $cart.customer
                                    - @not_empty: $cart.customer.account
                            parameters: [$account, $cart.customer.account]
            abandon:
                label: 'Abandon'
                message: 'You are going to abandon this shopping cart.'
                step_to: abandoned
                is_unavailable_hidden: true
                frontend_options:
                    icon: 'icon-remove-circle'
                transition_definition: abandon_definition
                form_options:
                    attribute_fields:
                        notes:
                            form_type: textarea
                            options:
                                required: false
            reopen:
                label: 'Reopen'
                step_to: open
                is_unavailable_hidden: true
                frontend_options:
                    icon: 'icon-backward'
                transition_definition: reopen_definition
                form_options:
                    attribute_fields:
                        notes:
                            form_type: textarea
                            options:
                                required: false

        transition_definitions:
            log_call_definition:
                pre_conditions:
                    @equal: [$cart.status.name, 'open']
                conditions:
                    @and:
                        - @not_empty:
                            parameters: $phone_number
                            message: 'Phone number must be set'
                        - @not_empty:
                            parameters: $call_subject
                            message: 'Call subject must be set'
                        - @not_empty:
                            parameters: $call_date
                            message: 'Call date must be set'
                        - @not_empty:
                            parameters: $call_direction
                            message: 'Call direction must be chosen'
                post_actions:
                    - @find_entity: # Set call status to in_progress
                        class: OroCRM\Bundle\CallBundle\Entity\CallStatus
                        identifier: 'in_progress'
                        attribute: $call_status
                    - @create_entity: # create Call
                        class: OroCRM\Bundle\CallBundle\Entity\Call
                        attribute: $call
                        data:
                            relatedContact: $contact
                            relatedAccount: $account
                            subject: $call_subject
                            phoneNumber: $phone_number
                            notes: $notes
                            callDateTime: $call_date
                            callStatus: $call_status
                            duration: $call_duration
                            direction: $call_direction
                    - @call_method:
                        method: 'addCall'
                        object: $cart
                        method_parameters: [$call]

            send_email_definition:
                pre_conditions:
                    @equal: [$cart.status.name, 'open']
                conditions:
                    @and:
                        - @not_empty:
                            parameters: $email_from
                            message: 'Email sender must be set'
                        - @not_empty:
                            parameters: $email_to
                            message: 'Email recipient must be set'
                        - @not_empty:
                            parameters: $email_subject
                            message: 'Email subject must be set'
                        - @not_empty:
                            parameters: $email_body
                            message: 'Email content must be chosen'
                post_actions:
                     - @send_email: # Send email
                         attribute: $email
                         from: $email_from
                         to: $email_to
                         subject: $email_subject
                         body: $email_body
                     - @call_method:
                         method: 'addEmail'
                         object: $cart
                         method_parameters: [$email]

            convert_definition:
                pre_conditions:
                    @equal: [$cart.status.name, 'open']
                post_actions:
                    - @find_entity: # Set cart status to converted
                        class: OroCRM\Bundle\MagentoBundle\Entity\CartStatus
                        identifier: 'converted'
                        attribute: $cart.status

            convert_to_opportunity_definition:
                pre_conditions:
                    @equal: [$cart.status.name, 'open']
                conditions:
                    @and:
                        - @not_empty:
                            parameters: $opportunity_name
                            message: 'Opportunity name must be set'
                        - @not_empty:
                            parameters: $opportunity_owner
                            message: 'Owner must be set'
                        - @not_empty:
                            parameters: $account
                            message: 'Account must be set'
                post_actions:
                    - @find_entity: # Set cart status to converted_to_opportunity
                        class: OroCRM\Bundle\MagentoBundle\Entity\CartStatus
                        identifier: 'converted_to_opportunity'
                        attribute: $cart.status
                    - @find_entity: # set status "In progress" to opportunity
                        class: OroCRM\Bundle\MagentoBundle\Entity\CartStatus
                        identifier: 'in_progress'
                        attribute: $.result.opportunity_status
                    - @create_entity: # create an opportunity
                        class: OroCRM\Bundle\SalesBundle\Entity\Opportunity
                        attribute: $cart.opportunity
                        data:
                            name: $opportunity_name
                            owner: $opportunity_owner
                            budgetAmount: $opportunity_budget
                            contact: $cart.customer.contact
                            account: $account
                            status: $.result.opportunity_status
                            notes: $notes

            abandon_definition:
                pre_conditions:
                    @equal: [$cart.status.name, 'open']
                post_actions:
                    - @find_entity: # Set cart status to lost
                        class: OroCRM\Bundle\MagentoBundle\Entity\CartStatus
                        identifier: 'lost'
                        attribute: $cart.status

            reopen_definition:
                conditions:
                    @or:
                        - @equal: [$cart.status.name, 'converted']
                        - @equal: [$cart.status.name, 'converted_to_opportunity']
                        - @equal: [$cart.status.name, 'lost']
                post_actions:
                    - @assign_value: # Reset latest opportunity, call and email data
                        - [$cart.opportunity, ~]
                        - [$opportunity_name, ~]
                        - [$opportunity_owner, ~]
                        - [$opportunity_budget, ~]

                        - [$call, ~]
                        - [$call_subject, ~]
                        - [$call_date, ~]
                        - [$call_direction, ~]
                        - [$call_status, ~]
                        - [$call_duration, ~]

                        - [$email, ~]
                        - [$email_subject, ~]
                        - [$email_body, ~]
                    - @find_entity: # Set cart status to open
                        class: OroCRM\Bundle\MagentoBundle\Entity\CartStatus
                        identifier: 'open'
                        attribute: $cart.status

    # Order Follow Up flow
    b2c_flow_order_follow_up:
        label: 'Order Follow Up'
        enabled: true
        entity: OroCRM\Bundle\MagentoBundle\Entity\Order
        entity_attribute: order
        start_step: not_contacted
        steps:
            not_contacted:
                label: 'Not contacted'
                order: 10
                allowed_transitions:
                    - send_email
                    - log_call
            emailed:
                label: 'Emailed'
                order: 20
                allowed_transitions:
                    - log_call
                    - record_feedback
            called:
                label: 'Called'
                order: 30
                allowed_transitions:
                    - no_reply
                    - record_feedback
            contacted:
                label: 'Contacted'
                order: 40
                is_final: true

        attributes:
            # Call related fields
            call:
                label: 'Call log'
                type: entity
                options:
                    class: OroCRM\Bundle\CallBundle\Entity\Call
            phone_number:
                label: 'Phone number'
                type: string
            call_subject:
                label: 'Call subject'
                type: string
            call_date:
                label: 'Call date'
                type: object
                options:
                    class: DateTime
            call_direction:
                label: 'Call direction'
                type: entity
                options:
                    class: OroCRM\Bundle\CallBundle\Entity\CallDirection
            call_status:
                label: 'Call status'
                type: entity
                options:
                    class: OroCRM\Bundle\CallBundle\Entity\CallStatus
            call_duration:
                label: 'Call duration'
                type: object
                options:
                    class: DateTime

            # Email related fields
            email:
                label: 'Email'
                type: entity
                options:
                    class: Oro\Bundle\EmailBundle\Entity\Email
            email_from:
                label: 'Email sender'
                type: string
            email_to:
                label: 'Email recipient'
                type: string
            email_subject:
                label: 'Email subject'
                type: string
            email_body:
                label: 'Email content'
                type: string

            # Other workflow attributes
            notes:
                label: 'Note'
                type: string
            feedback:
                label: 'Feedback'
                type: string
            account:
                label: 'Account'
                type: entity
                options:
                    class: OroCRM\Bundle\AccountBundle\Entity\Account
            contact:
                label: 'Contact'
                type: entity
                options:
                    class: OroCRM\Bundle\ContactBundle\Entity\Contact

        transitions:
            log_call:
                label: 'Log call'
                step_to: called
                is_start: true
                is_unavailable_hidden: true
                frontend_options:
                    icon: 'icon-phone'
                transition_definition: log_call_definition
                form_options:
                    attribute_fields:
                        phone_number:
                            form_type: text
                            options:
                                required: true
                                constraints:
                                    - NotBlank: ~
                        call_subject:
                            form_type: text
                            options:
                                required: true
                                constraints:
                                    - NotBlank: ~
                        call_date:
                            form_type: oro_datetime
                            options:
                                required: true
                                constraints:
                                    - NotBlank: ~
                        account:
                            form_type: orocrm_account_select
                            options:
                                required: false
                                label: 'Related to'
                        contact:
                            form_type: orocrm_contact_select
                            options:
                                required: false
                                label: 'Related contact'
                        call_direction:
                            form_type: entity
                            options:
                                class: OroCRM\Bundle\CallBundle\Entity\CallDirection
                                property: label
                                required: true
                                constraints:
                                    - NotBlank: ~
                        call_duration:
                            form_type: time
                            options:
                                required: false
                                widget: single_text
                                with_seconds: true
                        notes:
                            form_type: textarea
                            options:
                                required: false
                    init_actions:
                        # Assign either order customer primary phone or cart customer contact primary phone as phone
                        - @assign_value:
                            conditions:
                                @and:
                                    - @empty: $phone_number
                                    - @not_empty: $order.customer
                                    - @not_empty: $order.customer.contact
                                    - @not_empty: $order.customer.contact.primaryPhone
                            parameters: [$phone_number, $order.customer.contact.primaryPhone.phone]
                        - @assign_value:
                            conditions:
                                @and:
                                    - @empty: $phone_number
                                    - @not_empty: $order.cart
                                    - @not_empty: $order.cart.customer
                                    - @not_empty: $order.cart.customer.contact
                                    - @not_empty: $order.cart.customer.contact.primaryPhone
                            parameters: [$phone_number, $order.cart.customer.contact.primaryPhone.phone]

                        # Assign either order customer account or order cart customer account as account
                        - @assign_value:
                            conditions:
                                @and:
                                    - @empty: $account
                                    - @not_empty: $order.customer
                                    - @not_empty: $order.customer.account
                            parameters: [$account, $order.customer.account]
                        - @assign_value:
                            conditions:
                                @and:
                                    - @empty: $account
                                    - @not_empty: $order.cart
                                    - @not_empty: $order.cart.customer
                                    - @not_empty: $order.cart.customer.account
                            parameters: [$account, $order.cart.customer.account]

                        # Assign either order owner contact or order cart customer contact as contact
                        - @assign_value:
                            conditions:
                                @and:
                                    - @empty: $contact
                                    - @not_empty: $order.customer
                                    - @not_empty: $order.customer.contact
                            parameters: [$contact, $order.customer.contact]
                        - @assign_value:
                            conditions:
                                @and:
                                    - @empty: $contact
                                    - @not_empty: $order.cart
                                    - @not_empty: $order.cart.customer
                                    - @not_empty: $order.cart.customer.contact
                            parameters: [$contact, $order.cart.customer.contact]

                        - @create_object:
                            class: '\DateTime'
                            attribute: $call_date
                        - @create_object:
                            class: '\DateTime'
                            arguments:
                                - '00:00:00'
                            attribute: $call_duration
            send_email:
                label: 'Send email'
                step_to: emailed
                is_start: true
                is_unavailable_hidden: true
                frontend_options:
                    icon: 'icon-envelope-alt'
                    dialog:
                        dialogOptions:
                            width: 700
                transition_definition: send_email_definition
                form_options:
                    attribute_fields:
                        email_from:
                            form_type: oro_email_email_address
                            options:
                                required: true
                                constraints:
                                    - NotBlank: ~
                                    - Email: ~
                        email_to:
                            form_type: oro_email_email_address
                            options:
                                required: true
                                constraints:
                                    - NotBlank: ~
                                    - Email: ~
                        email_subject:
                            form_type: text
                            options:
                                required: true
                                constraints:
                                    - NotBlank: ~
                        email_body:
                            form_type: textarea
                            options:
                                required: true
                                attr:
                                    style: 'width: 90%;height: 200px;'
                                constraints:
                                    - NotBlank: ~
                        notes:
                            form_type: textarea
                            options:
                                required: false
                                attr:
                                    style: 'width: 90%;height: 60px'
                    init_actions:
                        - @assign_active_user: $.result.user
                        - @assign_value: [$email_from, $.result.user.email]

                        - @assign_value: #Assign email to as order owner email
                            conditions:
                                @and:
                                    - @empty: $email_to
                                    - @not_empty: $order.customer
                                    - @not_empty: $order.customer.email
                            parameters: [$email_to, $order.customer.email]
                        - @assign_value: #Assign email to as shopping cart customer email
                            conditions:
                                @and:
                                    - @empty: $email_to
                                    - @not_empty: $order.cart
                                    - @not_empty: $order.cart.email
                            parameters: [$email_to, $order.cart.email]
                        - @assign_value: #Assign email to as shopping cart customer contact primary email
                            conditions:
                                @and:
                                    - @empty: $email_to
                                    - @not_empty: $order.customer
                                    - @not_empty: $order.customer.contact
                                    - @not_empty: $order.customer.contact.primaryEmail
                            parameters: [$email_to, $order.customer.contact.primaryEmail.email]
                        - @assign_value: #Assign email to as shopping cart customer email
                            conditions:
                                @and:
                                    - @empty: $email_to
                                    - @not_empty: $order.cart
                                    - @not_empty: $order.cart.customer
                                    - @not_empty: $order.cart.customer.email
                            parameters: [$email_to, $order.cart.customer.email]
                        - @assign_value: #Assign email to as shopping cart customer contact primary email
                            conditions:
                                @and:
                                    - @empty: $email_to
                                    - @not_empty: $order.cart
                                    - @not_empty: $order.cart.customer.contact
                                    - @not_empty: $order.cart.customer.contact.primaryEmail
                            parameters: [$email_to, $order.cart.customer.contact.primaryEmail.email]
            no_reply:
                label: 'No reply'
                step_to: not_contacted
                is_unavailable_hidden: true
                frontend_options:
                    icon: 'icon-repeat'
                transition_definition: no_reply_definition
                form_options:
                    attribute_fields:
                        notes:
                            form_type: textarea
                            options:
                                required: false
            record_feedback:
                label: 'Record feedback'
                step_to: contacted
                is_start: true
                is_unavailable_hidden: true
                frontend_options:
                    icon: 'icon-ok'
                    class: 'btn-primary'
                transition_definition: record_feedback_definition
                form_options:
                    attribute_fields:
                        feedback:
                            form_type: textarea
                            options:
                                required: false
                        notes:
                            form_type: textarea
                            options:
                                required: false
        transition_definitions:
            log_call_definition:
                conditions:
                    @and:
                        - @not_empty:
                            parameters: $phone_number
                            message: 'Phone number must be set'
                        - @not_empty:
                            parameters: $call_subject
                            message: 'Call subject must be set'
                        - @not_empty:
                            parameters: $call_date
                            message: 'Call date must be set'
                        - @not_empty:
                            parameters: $call_direction
                            message: 'Call direction must be chosen'
                post_actions:
                    - @find_entity: # Set call status to in_progress
                        class: OroCRM\Bundle\CallBundle\Entity\CallStatus
                        identifier: 'in_progress'
                        attribute: $call_status
                    - @create_entity: # create Call
                        class: OroCRM\Bundle\CallBundle\Entity\Call
                        attribute: $call
                        data:
                            relatedContact: $contact
                            relatedAccount: $account
                            subject: $call_subject
                            phoneNumber: $phone_number
                            notes: $notes
                            callDateTime: $call_date
                            callStatus: $call_status
                            duration: $call_duration
                            direction: $call_direction
                    - @call_method:
                        method: 'addCall'
                        object: $order
                        method_parameters: [$call]

            send_email_definition:
                conditions:
                    @and:
                        - @not_empty:
                            parameters: $email_from
                            message: 'Email sender must be set'
                        - @not_empty:
                            parameters: $email_to
                            message: 'Email recipient must be set'
                        - @not_empty:
                            parameters: $email_subject
                            message: 'Email subject must be set'
                        - @not_empty:
                            parameters: $email_body
                            message: 'Email content must be chosen'
                post_actions:
                    - @send_email: # Send email
                        attribute: $email
                        from: $email_from
                        to: $email_to
                        subject: $email_subject
                        body: $email_body
                    - @call_method:
                        method: 'addEmail'
                        object: $order
                        method_parameters: [$email]
            no_reply_definition: [] # do nothing
            record_feedback_definition: [] # do nothing
